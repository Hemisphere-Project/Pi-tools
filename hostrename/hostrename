#!/bin/bash

if [ "$#" -eq  "0" ]; then
 	name=rastapi-unknown
else
 	name=$1
fi

echo "[hostrename] Setting name: $name"

current=$(cat /etc/hostname)
if [[ $current == $name ]]; then
	echo "[hostrename] hostname already set as $name"
	exit 0
fi
	
# try rw 10 times and touch /boot/VERSION to confirm rw
rw
systemctl restart systemd-hostnamed
sed -i -E 's/^127.0.1.1.*/127.0.1.1\t'"$name"'/' /etc/hosts
for file in /boot/wifi/*-hotspot.nmconnection /boot/wifi/_disabled/*-hotspot.nmconnection; do
	if [ -f "$file" ]; then
		sed -i -E 's/^ssid=.*/ssid='"$name"'/' "$file"
		echo "updated $(basename "$file") name"
	fi
done

# try hostnamectl set-hostname first, if it fails, fallback to manual edit

hostnamectl set-hostname "$name"
sync
systemctl restart avahi-daemon
setnet
sync
ro
echo "[hostrename] hostname changed to $name"    
