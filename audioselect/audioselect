#!/bin/bash

# DEBUG:
# aplay -l
# aplay -v marimba.wav
# cat /proc/asound/devices
# cat /proc/asound/pcm
# cat /proc/asound/cards

BASEPATH="$(dirname "$(readlink -f "$0")")"

echo "[audioselect] auto-selecting audio output device or specify: hdmi0/hdmi1/analog/usb/both"

###
### RENAMING CARDS
###

#
# check HDMI0 card device name (do this FIRST to avoid confusion with analog)
#
find_hdmi0card=$(aplay -l | grep -iE "hdmi|vc4-hdmi" -m1)
if [ "$find_hdmi0card" ]; then
    target_hdmi0card=$(echo $find_hdmi0card | awk '{print $2}' | tr -d ':')
    current_hdmi0card=$(cat /etc/asound.conf | awk '/pcm.hdmi0/{getline; getline; getline; getline; getline; getline; print}' | awk '{print $NF}')
    if [[ "$current_hdmi0card" != "$target_hdmi0card" ]]; then
        echo "HDMI0 card found as card $target_hdmi0card instead of $current_hdmi0card, renaming..."
        rw
        # Use word boundaries to prevent cascading replacements
        sed -i "s/\bcard $current_hdmi0card\b/card $target_hdmi0card/g" /etc/asound.conf
        sync
        ro
        echo "HDMI0 card set to $target_hdmi0card"
    fi
else
    echo "No HDMI0 audio card found using 'aplay -l'"
fi

#
# check HDMI1 card device name (Pi4+ only)
#
find_hdmi1card=$(aplay -l | grep -iE "hdmi|vc4-hdmi" | sed -n '2p')
if [ "$find_hdmi1card" ]; then
    target_hdmi1card=$(echo $find_hdmi1card | awk '{print $2}' | tr -d ':')
    # Check if asound.conf has hdmi1 section (Pi4+ config)
    if grep -q "^pcm.hdmi1" /etc/asound.conf; then
        current_hdmi1card=$(cat /etc/asound.conf | awk '/pcm.hdmi1/{getline; getline; getline; getline; getline; getline; print}' | awk '{print $NF}')
        if [[ "$current_hdmi1card" != "$target_hdmi1card" ]]; then
            echo "HDMI1 card found as card $target_hdmi1card instead of $current_hdmi1card, renaming..."
            rw
            # Use word boundaries to prevent cascading replacements
            sed -i "s/\bcard $current_hdmi1card\b/card $target_hdmi1card/g" /etc/asound.conf
            sync
            ro
            echo "HDMI1 card set to $target_hdmi1card"
        fi
    else
        echo "HDMI1 card detected but config doesn't support it (use asound.conf-pi4)"
    fi
else
    echo "No HDMI1 audio card found (single HDMI system)"
fi

#
# check ANALOG card device name (find bcm2835 that is NOT HDMI)
#
find_analogcard=$(aplay -l | grep bcm2835 | grep -viE "hdmi|vc4-hdmi" -m1)
if [ "$find_analogcard" ]; then
    target_analogcard=$(echo $find_analogcard | awk '{print $2}' | tr -d ':')
    current_analogcard=$(cat /etc/asound.conf | awk '/pcm.analog/{getline; getline; print}' | awk '{print $NF}')
    if [[ "$current_analogcard" != "$target_analogcard" ]]; then
        echo "ANALOG card found as card $target_analogcard instead of $current_analogcard, renaming..."
        rw
        # Use word boundaries to prevent cascading replacements
        sed -i "s/\bcard $current_analogcard\b/card $target_analogcard/g" /etc/asound.conf
        sync
        ro
        echo "ANALOG card set to $target_analogcard"
    fi
else
    echo "No ANALOG audio card found using 'aplay -l'"
fi

#
# check USB card device name
#
find_usbcard=$(aplay -l | grep USB -m1)
if [ "$find_usbcard" ]; then
    target_usbcard=$(echo $find_usbcard | awk '{print $2}' | tr -d ':')
    current_usbcard=$(cat /etc/asound.conf | awk '/ctl.usb/{getline; getline; print}' | awk '{print $NF}')
    if [[ "$current_usbcard" != "$target_usbcard" ]]; then
        echo "USB card found as card $target_usbcard instead of $current_usbcard, renaming..."
        rw
        # Use word boundaries to prevent cascading replacements
        sed -i "s/\bcard $current_usbcard\b/card $target_usbcard/g" /etc/asound.conf
        sync
        ro
        echo "USB card set to $target_usbcard"
    fi
else
    echo "No USB audio card found using 'aplay -l'"
fi

###
### CHECKING ROUTE
###

echo "-----"

# get current route
current_route=$(cat /etc/asound.conf | grep pcm.\!default -m1 | awk -F ' ' '{print $2}')

# target route is from argument if present or current route otherwise
target_route=$1
if [ -z "$target_route" ]; then
    target_route=$current_route
fi

# handle legacy "jack" naming - convert to "analog"
if [ "$target_route" = "jack" ]; then
    echo "Legacy mode: 'jack' renamed to 'analog'"
    target_route="analog"
fi

# if target route is analog, try both (analog + USB if available)
if [ "$target_route" = "analog" ]; then
    target_route="both"
fi

# if target route is hdmi0, check if hdmi0 card is available
if [ "$target_route" = "hdmi0" ]; then
    if [ -z "$find_hdmi0card" ]; then
        target_route="both"
        echo "=> No HDMI0 audio card found, falling back to ANALOG/USB"
    else
        target_route="hdmi0"
        echo "=> using HDMI0 audio card found as card $target_hdmi0card"
    fi
fi

# if target route is hdmi1, check if hdmi1 card is available
if [ "$target_route" = "hdmi1" ]; then
    if [ -z "$find_hdmi1card" ]; then
        echo "=> No HDMI1 audio card found, falling back to HDMI0"
        if [ -z "$find_hdmi0card" ]; then
            target_route="both"
            echo "=> No HDMI0 either, falling back to ANALOG/USB"
        else
            target_route="hdmi0"
            echo "=> using HDMI0 audio card found as card $target_hdmi0card"
        fi
    else
        if grep -q "^pcm.hdmi1" /etc/asound.conf; then
            target_route="hdmi1"
            echo "=> using HDMI1 audio card found as card $target_hdmi1card"
        else
            echo "=> HDMI1 card exists but config doesn't support it, using HDMI0"
            target_route="hdmi0"
        fi
    fi
fi

# if target route is usb or both, check if usb card is available
if [ "$target_route" = "usb" ] || [ "$target_route" = "both" ]; then
    if [ -z "$find_usbcard" ]; then
        target_route="analog"
        echo "=> No USB audio card found, falling back to ANALOG"
    elif [ "$target_route" = "both" ]; then
        echo "=> using BOTH usb and analog audio cards"
    else
        echo "=> using USB audio card found as card $target_usbcard"
    fi
fi

echo "-----"

# get current route
current_route=$(cat /etc/asound.conf | grep pcm.\!default -m1 | awk -F ' ' '{print $2}')

# apply new route if necessary
if [[ "$current_route" != "$target_route" ]]; then
    echo "Audio route found as $current_route instead of $target_route, updating..."
    rw
    # sed -i "s/?USB?/$usb_card/g" /etc/asound.conf
    sed -i "s/pcm.!default $current_route/pcm.!default $target_route/g" /etc/asound.conf
    sed -i "s/ctl.!default $current_route/ctl.!default $target_route/g" /etc/asound.conf
    sync
    ro
    echo "Audio set to $target_route"
else
    echo "Audio already set to $target_route"
fi




# Volume and settings
amixer -D analog cset numid=1 -- 99% 2>/dev/null || amixer -D jack cset numid=1 -- 99% 2>/dev/null || true
if [ "$target_route" = "both" ]; then
    amixer -D usb set Speaker -- 95% 2>/dev/null || true
    amixer -D usb sset PCM -- 95% 2>/dev/null || true
fi
